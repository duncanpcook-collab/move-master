<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Existing head content remains unchanged] -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move Master - Home Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* [Existing styles remain unchanged] */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        /* [Rest of the styles remain unchanged] */
    </style>
</head>
<body class="text-gray-800">
    <!-- [Existing body content up to the box modal remains unchanged] -->
    <div id="box-modal" class="modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 modal-content animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 id="box-modal-title" class="text-2xl font-bold">Add New Box</h2>
                <button onclick="window.closeBoxModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="box-form" class="space-y-4">
                <input type="hidden" id="box-id">
                <div>
                    <label for="box-number" class="block text-sm font-medium">Box Number</label>
                    <input type="text" id="box-number" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="box-room-area" class="block text-sm font-medium">Room / Area</label>
                    <input type="text" id="box-room-area" list="room-suggestions" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="box-type-select" class="block text-sm font-medium">Box Type</label>
                    <div class="flex items-center gap-4 mt-1">
                        <select id="box-type-select" class="block w-full border-gray-300 rounded-md shadow-sm"></select>
                        <img id="box-type-thumbnail" src="" class="h-12 w-12 rounded-md object-contain border border-gray-200 hidden">
                    </div>
                </div>
                <div id="custom-dimensions-container" class="hidden">
                    <label class="block text-sm font-medium">Custom Dimensions (cm)</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <input type="number" id="box-height" placeholder="H" class="block w-full border-gray-300 rounded-md shadow-sm">
                        <input type="number" id="box-width" placeholder="W" class="block w-full border-gray-300 rounded-md shadow-sm">
                        <input type="number" id="box-length" placeholder="L" class="block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div><p class="text-sm text-gray-600">Calculated Volume: <span id="box-volume" class="font-bold text-indigo-600">0.000 mÂ³</span></p></div>
                <div>
                    <label class="block text-sm font-medium">Photo of Box</label>
                    <div class="mt-1 flex items-center gap-4">
                        <img id="box-photo-preview" class="hidden photo-preview-thumb">
                        <input type="file" id="box-photo-input" accept="image/*" class="hidden">
                        <label for="box-photo-input" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md">
                            <span><i class="fas fa-camera mr-2"></i>Take/Upload</span>
                        </label>
                        <button type="button" id="box-remove-photo-btn" class="hidden text-red-600">Remove</button>
                    </div>
                </div>
                <div id="qr-code-section" class="pt-4 border-t mt-4 text-center hidden">
                    <div id="qr-code-container" class="mx-auto w-40 h-40 bg-gray-100 rounded-lg flex items-center justify-center text-sm text-gray-500 p-2">QR Code will appear here</div>
                    <div class="mt-4 flex justify-center space-x-2">
                        <button type="button" onclick="window.generateQRCodeForBox()" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700">
                            <i class="fas fa-qrcode mr-2"></i>Generate QR
                        </button>
                        <button type="button" id="print-qr-btn" onclick="window.printQRCode()" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                            <i class="fas fa-print mr-2"></i>Print
                        </button>
                    </div>
                    <p id="qr-new-box-note" class="text-xs text-gray-500 mt-2">Save the box first to generate a QR code.</p>
                </div>
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="window.closeBoxModal()" class="bg-gray-200 px-6 py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="save-box-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Save Box</button>
                </div>
            </form>
        </div>
    </div>
    <!-- [Rest of the body content remains unchanged] -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let boxes = [];
        let items = [];
        let itemToDelete = null;
        let boxToDelete = null;
        let boxPhotoDataUrlCache = null;
        let itemPhotosCache = [];
        let currentPhotoGallery = [];
        let currentPhotoIndex = 0;
        let db, auth;
        let isOwnerLoggedIn = false;
        let unsubscribeBoxes = () => {};
        let unsubscribeItems = () => {};

        // PASTE YOUR UNIQUE FIREBASE USER ID HERE
        const OWNER_USER_ID = "FzazuoOmr8ZVyM6r2EOGZEg1LqB3";

        // --- Box Presets (Simplified with URLs) ---
        const MEDIUM_BOX_IMG_URL = 'https://placehold.co/100x100/DEB887/333333?text=Medium';
        const JUMBO_BOX_IMG_URL = 'https://placehold.co/100x100/DEB887/333333?text=Jumbo';

        const BOX_PRESETS = [
            { id: 'medium', name: 'Medium Box Heavy Duty (40L)', w: 40.3, l: 30.1, h: 33.0, imgSrc: MEDIUM_BOX_IMG_URL },
            { id: 'jumbo', name: 'Jumbo Box Heavy Duty (104L)', w: 43.1, l: 40.6, h: 59.6, imgSrc: JUMBO_BOX_IMG_URL },
        ];

        // --- DOM ELEMENT VARIABLES ---
        let loginBtn, logoutBtn, addBoxBtn, addItemBtn, loginModal, loginForm, loginError, userIdDisplay,
            inventoryListEl, boxModal, itemModal, photoModal, confirmModal, infoModal, searchInput,
            roomFilter, boxDimensionInputs, isNewCheckbox, newItemDetails, qrCodeContainer, printQrBtn,
            qrCodeSection, qrNewBoxNote, boxPhotoInput, boxPhotoPreview, boxRemovePhotoBtn, itemPhotoInput,
            itemPhotosContainer, itemAddPhotoLabel, galleryPrevBtn, galleryNextBtn, fullPhoto, loadingOverlay,
            boxTypeSelect, boxTypeThumbnail, customDimensionsContainer;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            assignDOMElements();
            addEventListeners();
            attachFunctionsToWindow();
            initFirebase();
        });

        function assignDOMElements() {
            // [Existing assignments remain unchanged]
            loginBtn = document.getElementById('login-btn');
            logoutBtn = document.getElementById('logout-btn');
            addBoxBtn = document.getElementById('add-box-btn');
            addItemBtn = document.getElementById('add-item-btn');
            loginModal = document.getElementById('login-modal');
            loginForm = document.getElementById('login-form');
            loginError = document.getElementById('login-error');
            userIdDisplay = document.getElementById('user-id-display');
            inventoryListEl = document.getElementById('inventory-list');
            boxModal = document.getElementById('box-modal');
            itemModal = document.getElementById('item-modal');
            photoModal = document.getElementById('photo-modal');
            confirmModal = document.getElementById('confirm-modal');
            infoModal = document.getElementById('info-modal');
            searchInput = document.getElementById('search-input');
            roomFilter = document.getElementById('room-filter');
            boxDimensionInputs = ['box-height', 'box-width', 'box-length'].map(id => document.getElementById(id));
            isNewCheckbox = document.getElementById('is-new-checkbox');
            newItemDetails = document.getElementById('new-item-details');
            qrCodeContainer = document.getElementById('qr-code-container');
            printQrBtn = document.getElementById('print-qr-btn');
            qrCodeSection = document.getElementById('qr-code-section');
            qrNewBoxNote = document.getElementById('qr-new-box-note');
            boxPhotoInput = document.getElementById('box-photo-input');
            boxPhotoPreview = document.getElementById('box-photo-preview');
            boxRemovePhotoBtn = document.getElementById('box-remove-photo-btn');
            itemPhotoInput = document.getElementById('item-photo-input');
            itemPhotosContainer = document.getElementById('item-photos-container');
            itemAddPhotoLabel = document.getElementById('item-add-photo-label');
            galleryPrevBtn = document.getElementById('gallery-prev-btn');
            galleryNextBtn = document.getElementById('gallery-next-btn');
            fullPhoto = document.getElementById('full-photo');
            loadingOverlay = document.getElementById('loading-overlay');
            boxTypeSelect = document.getElementById('box-type-select');
            boxTypeThumbnail = document.getElementById('box-type-thumbnail');
            customDimensionsContainer = document.getElementById('custom-dimensions-container');
        }

        function addEventListeners() {
            // [Existing event listeners remain unchanged]
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('box-form').addEventListener('submit', handleSaveBox);
            document.getElementById('item-form').addEventListener('submit', handleSaveItem);
            boxDimensionInputs.forEach(input => input.addEventListener('input', calculateVolume));
            isNewCheckbox.addEventListener('change', () => newItemDetails.classList.toggle('hidden', !isNewCheckbox.checked));
            boxTypeSelect.addEventListener('change', handleBoxTypeChange);
            boxPhotoInput.addEventListener('change', handleBoxPhotoUpload);
            boxRemovePhotoBtn.addEventListener('click', resetBoxPhotoPreview);
            itemPhotoInput.addEventListener('change', handleItemPhotoUpload);
            galleryPrevBtn.addEventListener('click', () => { if (currentPhotoIndex > 0) { currentPhotoIndex--; showGalleryPhoto(); } });
            galleryNextBtn.addEventListener('click', () => { if (currentPhotoIndex < currentPhotoGallery.length - 1) { currentPhotoIndex++; showGalleryPhoto(); } });
            document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);
            document.getElementById('cancel-delete').addEventListener('click', closeConfirmModal);
            searchInput.addEventListener('input', render);
            roomFilter.addEventListener('change', render);
            window.addEventListener('click', (e) => { if (e.target.classList.contains('modal-backdrop')) { closeAllModals(); } });
        }

        function attachFunctionsToWindow() {
            // [Existing functions remain unchanged]
            window.openLoginModal = openLoginModal;
            window.closeLoginModal = closeLoginModal;
            window.openBoxModal = openBoxModal;
            window.closeBoxModal = closeBoxModal;
            window.openItemModal = openItemModal;
            window.closeItemModal = closeItemModal;
            window.logout = async () => { await signOut(auth); };
            window.exportListWithImages = exportListWithImages;
            window.resetFilters = resetFilters;
            window.toggleBoxItems = toggleBoxItems;
            window.showQRCodeForBox = showQRCodeForBox;
            window.editBox = editBox;
            window.confirmDelete = confirmDelete;
            window.openPhotoModal = openPhotoModal;
            window.closePhotoModal = closePhotoModal;
            window.editItem = editItem;
            window.removeItemPhoto = removeItemPhoto;
            window.generateQRCodeForBox = generateQRCodeForBox;
            window.printQRCode = printQRCode;
            window.closeInfoModal = closeInfoModal;
            window.formatCurrency = formatCurrency;
        }

        async function initFirebase() {
            try {
                if (OWNER_USER_ID === "FzazuoOmr8ZVyM6r2EOGZEg1LqB3") {
                    loadingOverlay.innerHTML = '<p class="text-red-600 font-semibold text-center p-4">SETUP REQUIRED<br><span class="font-normal text-sm text-gray-600">Please replace the placeholder Owner User ID in the HTML file to connect to your data.</span></p>';
                    return;
                }
                const firebaseConfig = {
                    apiKey: "AIzaSyCVWdQVQbPWvfxUl0VSjkOGzuC0mm_CuSU",
                    authDomain: "my-move-master.firebaseapp.com",
                    projectId: "my-move-master",
                    storageBucket: "my-move-master.appspot.com",
                    messagingSenderId: "642424710686",
                    appId: "1:642424710686:web:119de596a4826a68b1f00f",
                    measurementId: "G-R1X3RKVQES"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    updateUIForLoginState(user);
                    const ownerIsLoggedIn = user && user.uid === OWNER_USER_ID;
                    if (ownerIsLoggedIn) {
                        attachFirestoreListeners();
                    } else {
                        unsubscribeBoxes();
                        unsubscribeItems();
                        boxes = [];
                        items = [];
                        render();
                        loadingOverlay.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingOverlay.innerHTML = '<p class="text-red-600 font-semibold">Connection failed. Please check your Firebase config.</p>';
            }
        }

        function attachFirestoreListeners() {
            loadingOverlay.style.display = 'flex';
            const boxesCollection = collection(db, "users", OWNER_USER_ID, "boxes");
            unsubscribeBoxes = onSnapshot(boxesCollection, (snapshot) => {
                boxes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Error listening to boxes:", error));

            const itemsCollection = collection(db, "users", OWNER_USER_ID, "items");
            unsubscribeItems = onSnapshot(itemsCollection, (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadingOverlay.style.display = 'none';
                render();
            }, (error) => {
                console.error("Error listening to items:", error);
                loadingOverlay.style.display = 'none';
            });
        }

        function updateUIForLoginState(user) {
            isOwnerLoggedIn = user && user.uid === OWNER_USER_ID;
            loginBtn.classList.toggle('hidden', isOwnerLoggedIn);
            logoutBtn.classList.toggle('hidden', !isOwnerLoggedIn);
            addBoxBtn.classList.toggle('hidden', !isOwnerLoggedIn);
            addItemBtn.classList.toggle('hidden', !isOwnerLoggedIn);

            if (user) {
                if (isOwnerLoggedIn) {
                    userIdDisplay.textContent = `Logged in as Admin: ${user.email}`;
                    document.getElementById('empty-state-subtext').textContent = 'You are logged in! Start adding boxes and items.';
                } else {
                    userIdDisplay.textContent = `Logged in as Guest (Read-Only): ${user.email}`;
                    document.getElementById('empty-state-subtext').textContent = 'Login with the correct admin account to make changes.';
                }
            } else {
                userIdDisplay.textContent = 'Public Read-Only View';
                document.getElementById('empty-state-subtext').textContent = 'Login as an admin to start adding boxes and items.';
            }
            render();
        }

        function render() {
            // [Existing render function remains unchanged]
        }

        function createBoxEl(box, boxItems) {
            // [Existing createBoxEl function remains unchanged]
        }

        function createItemHTML(item) {
            // [Existing createItemHTML function remains unchanged]
        }

        async function handleLogin(e) {
            // [Existing handleLogin function remains unchanged]
        }

        async function handleSaveBox(e) {
            e.preventDefault();
            if (!isOwnerLoggedIn) {
                showInfoModal("You must be logged in as admin to save changes.");
                return;
            }
            const saveBtn = document.getElementById('save-box-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Saving...`;

            const id = document.getElementById('box-id').value;
            const boxData = {
                number: document.getElementById('box-number').value,
                room: document.getElementById('box-room-area').value,
                height: parseFloat(document.getElementById('box-height').value) || 0,
                width: parseFloat(document.getElementById('box-width').value) || 0,
                length: parseFloat(document.getElementById('box-length').value) || 0,
                photoDataUrl: boxPhotoDataUrlCache,
                volume: 0 // Will be calculated below
            };
            boxData.volume = (boxData.height * boxData.width * boxData.length) / 1000000;

            try {
                if (id) {
                    // Update existing box
                    await setDoc(doc(db, "users", OWNER_USER_ID, "boxes", id), boxData, { merge: true });
                    showInfoModal("Box updated successfully!");
                } else {
                    // Add new box
                    const docRef = await addDoc(collection(db, "users", OWNER_USER_ID, "boxes"), boxData);
                    showInfoModal("Box added successfully!");
                }
                closeBoxModal();
                render(); // Refresh the UI
            } catch (error) {
                console.error("Error saving box:", error);
                showInfoModal("Failed to save box. Please check the console for details.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Box';
            }
        }

        async function handleSaveItem(e) {
            // [Existing handleSaveItem function remains unchanged]
        }

        function toggleBoxItems(boxId) {
            // [Existing toggleBoxItems function remains unchanged]
        }

        function updateSummary() {
            // [Existing updateSummary function remains unchanged]
        }

        function updateRoomFilter() {
            // [Existing updateRoomFilter function remains unchanged]
        }

        function editBox(id) {
            const box = boxes.find(b => b.id === id);
            if (!box) return;
            document.getElementById('box-form').reset();
            document.getElementById('box-id').value = box.id;
            document.getElementById('box-number').value = box.number;
            document.getElementById('box-room-area').value = box.room;
            document.getElementById('box-height').value = box.height;
            document.getElementById('box-width').value = box.width;
            document.getElementById('box-length').value = box.length;
            document.getElementById('box-modal-title').textContent = 'Edit Box';
            qrCodeContainer.innerHTML = '<div class="text-sm text-gray-500 p-2 text-center">QR Code will appear here</div>';
            printQrBtn.classList.add('hidden');
            qrNewBoxNote.classList.remove('hidden');
            qrCodeSection.classList.add('hidden');
            boxPhotoDataUrlCache = box.photoDataUrl;
            updateBoxPhotoPreview();
            populateBoxTypeSelect(box);
            boxModal.style.display = 'flex';
            calculateVolume();
        }

        function calculateVolume() {
            // [Existing calculateVolume function remains unchanged]
        }

        function editItem(id) {
            // [Existing editItem function remains unchanged]
        }

        function updateBoxSelector(selectedId) {
            // [Existing updateBoxSelector function remains unchanged]
        }

        function generateQRCodeForBox() {
            // [Existing generateQRCodeForBox function remains unchanged]
        }

        function showQRCodeForBox(boxId) {
            // [Existing showQRCodeForBox function remains unchanged]
        }

        function printQRCode() {
            // [Existing printQRCode function remains unchanged]
        }

        function populateBoxTypeSelect(box = null) {
            // [Existing populateBoxTypeSelect function remains unchanged]
        }

        function handleBoxTypeChange() {
            // [Existing handleBoxTypeChange function remains unchanged]
        }

        function exportListWithImages() {
            // [Existing exportListWithImages function remains unchanged]
        }

        function resizeAndProcessImage(file, callback) {
            // [Existing resizeAndProcessImage function remains unchanged]
        }

        function handleBoxPhotoUpload(e) {
            // [Existing handleBoxPhotoUpload function remains unchanged]
        }

        function updateBoxPhotoPreview() {
            // [Existing updateBoxPhotoPreview function remains unchanged]
        }

        function resetBoxPhotoPreview() {
            // [Existing resetBoxPhotoPreview function remains unchanged]
        }

        function handleItemPhotoUpload(e) {
            // [Existing handleItemPhotoUpload function remains unchanged]
        }

        function renderItemPhotoPreviews() {
            // [Existing renderItemPhotoPreviews function remains unchanged]
        }

        function removeItemPhoto(index) {
            // [Existing removeItemPhoto function remains unchanged]
        }

        function resetItemPhotoPreviews() {
            // [Existing resetItemPhotoPreviews function remains unchanged]
        }

        function openPhotoModal(urls, index) {
            // [Existing openPhotoModal function remains unchanged]
        }

        function showGalleryPhoto() {
            // [Existing showGalleryPhoto function remains unchanged]
        }

        function closePhotoModal() {
            // [Existing closePhotoModal function remains unchanged]
        }

        function confirmDelete(type, id) {
            // [Existing confirmDelete function remains unchanged]
        }

        async function executeDelete() {
            // [Existing executeDelete function remains unchanged]
        }

        function closeAllModals() {
            // [Existing closeAllModals function remains unchanged]
        }

        function closeLoginModal() {
            // [Existing closeLoginModal function remains unchanged]
        }

        function closeBoxModal() {
            // [Existing closeBoxModal function remains unchanged]
        }

        function closeItemModal() {
            // [Existing closeItemModal function remains unchanged]
        }

        function closeConfirmModal() {
            // [Existing closeConfirmModal function remains unchanged]
        }

        function openLoginModal() {
            // [Existing openLoginModal function remains unchanged]
        }

        function openBoxModal() {
            document.getElementById('box-form').reset();
            document.getElementById('box-id').value = '';
            document.getElementById('box-modal-title').textContent = 'Add New Box';
            qrCodeContainer.innerHTML = '<div class="text-sm text-gray-500 p-2 text-center">QR Code will appear here</div>';
            printQrBtn.classList.add('hidden');
            qrNewBoxNote.classList.remove('hidden');
            qrCodeSection.classList.add('hidden');
            resetBoxPhotoPreview();
            populateBoxTypeSelect();
            boxModal.style.display = 'flex';
            calculateVolume();
        }

        function openItemModal() {
            // [Existing openItemModal function remains unchanged]
        }

        function showInfoModal(message, title = 'Heads Up!') {
            // [Existing showInfoModal function remains unchanged]
        }

        function closeInfoModal() {
            // [Existing closeInfoModal function remains unchanged]
        }

        function formatCurrency(num) {
            // [Existing formatCurrency function remains unchanged]
        }

        function resetFilters() {
            // [Existing resetFilters function remains unchanged]
        }
    </script>
</body>
</html>